# Term-Relay 多仓迁移执行计划

## 1. 迁移目标

将当前单仓逐步迁移到“私有产品仓 + 开源 SDK/插件仓”的结构，确保：

1. 不泄露闭源代码  
2. 发布不中断  
3. 现有用户体验不回退  
4. 开源生态可持续演进

## 2. 分阶段执行

## Phase 0：清单冻结（3-5 天）

- 输出最终“导出目录白名单”与“永不导出黑名单”
- 确认仓库命名、权限、Owner、CI 基线
- 确认开源 license 与贡献协议（CLA/DCO）

交付物：

- 仓库与目录映射表（冻结）
- 安全审计清单（密钥/证书/私有配置）

## Phase 1：新仓创建与基线初始化（3-5 天）

- 创建私有仓：
  - `term-relay-platform`
  - `term-relay-cli`
  - `term-relay-ops`
- 创建开源仓：
  - `term-relay-sdk`
  - `term-relay-iterm2`
- 初始化：
  - README、CODEOWNERS、Issue/PR 模板
  - CI 最小流水线（lint/test/release dry-run）

## Phase 2：代码切分与首次同步（1-2 周）

- 执行首次历史切分（建议保留 commit 历史）
- 导出开源目录到目标公开仓
- 私有仓完成闭源模块归位
- 跑全量回归：
  - CLI 测试
  - Hub 测试
  - SDK 测试
  - iTerm2 bridge/list/share 冒烟

验收标准：

- 私有仓可独立构建发布
- 开源仓可独立构建测试
- 当前主流程（bind/share/web）不受影响

## Phase 3：发布流水线与版本策略上线（1 周）

- 建立自动化：
  - 私有主线 tag -> CLI release
  - SDK tag -> PyPI/GitHub Release（如适用）
  - iTerm2 仓 tag -> Release 包
- 建立跨仓兼容矩阵：
  - CLI vX <-> Hub vY
  - SDK vA <-> 协议版本

## Phase 4：运营化与治理（持续）

- 开源仓社区流程（triage、贡献回流）
- 私有仓稳定性治理（SLO、告警、变更审计）
- 产品化迭代（套餐、账单、配额、转化）

## 3. 关键任务清单（按角色）

## 3.1 架构/平台

1. 定义跨仓 API 兼容策略  
2. 定义协议版本治理流程  
3. 完成导出同步工具（带审计日志）  

## 3.2 后端（Hub/Platform）

1. 实现套餐/配额数据模型  
2. 实现会话创建配额闸门（原子校验）  
3. 实现支付回调与订阅状态更新  

## 3.3 CLI

1. 增加配额超限友好提示  
2. 增加版本与兼容信息输出（`version --verbose`）  
3. 完成多平台打包签名与回滚机制  

## 3.4 SDK/插件

1. 稳定 `v1` 协议并冻结 breaking change 流程  
2. 补齐 SDK 示例与模板  
3. 完善 iTerm2 插件安装、升级、故障定位文档  

## 3.5 前端/官网

1. 官网套餐页（Free/Plus/Pro）  
2. 控制台配额展示（当前使用/上限）  
3. 升级支付入口与支付结果反馈  

## 4. 风险与对策

1. 风险：迁移期间发布中断  
- 对策：先双写流水线，稳定后切流

2. 风险：开源导出误带闭源代码  
- 对策：白名单导出 + 审计脚本 + 人工复核

3. 风险：多仓版本漂移导致兼容问题  
- 对策：兼容矩阵 + 集成回归 + 发布前 smoke test

4. 风险：社区 PR 难回流  
- 对策：固定回流窗口 + 机器人辅助 cherry-pick

## 5. Definition of Done（迁移完成标准）

1. 私有仓可独立发布 Hub 与 CLI  
2. 开源 SDK 与 iTerm2 仓可独立发布  
3. 版本兼容矩阵与发布流程文档化  
4. 官网套餐与配额链路在线可用  
5. 安全审计通过（无敏感信息泄漏）

